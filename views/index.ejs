<% title = "Bienvenu !" %>

<%- contentFor('mainWithoutMarge') %>
<%- contentFor('main') %>

<h2>Souscription</h2>

<input type="email" id="email" placeholder="Email"  value="emile00013@gmail.com" required />
<div id="card-element"></div>
<button id="submit">S'abonner</button>

<div id="message"></div>
<script src="https://js.stripe.com/v3/"></script>

<script>
  const stripe = Stripe("pk_test_51SxQASJ7uGufFKhIp92vPaUU3Fx4wN2RsuSYr639oSIcw8PXbsFfhAssEAnegVDBYmommSyQk8RKTv0KGzGoegcW00BuzIUHwH"); // cl√© publique

  const elements = stripe.elements();

  const card = elements.create("card");
  card.mount("#card-element");

  const button = document.getElementById("submit");

  button.addEventListener("click", async () => {
    const email = document.getElementById("email").value;

    // 1Ô∏è‚É£ Cr√©er PaymentMethod
    const { paymentMethod, error } = await stripe.createPaymentMethod({
      type: "card",
      card: card,
      billing_details: {
        email: email,
      },
    });

    if (error) {
      document.getElementById("message").innerText = error.message;
      return;
    }

    // 2Ô∏è‚É£ Envoyer au backend
    const response = await fetch("/create-subscription", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        email: email,
        paymentMethodId: paymentMethod.id,
      }),
    });

    const data = await response.json();

    if (data.error) {
      document.getElementById("message").innerText = data.error;
      return;
    }

    // 3Ô∏è‚É£ Confirmer le paiement si n√©cessaire
    const confirmResult = await stripe.confirmCardPayment(
      data.clientSecret
    );

    if (confirmResult.error) {
      document.getElementById("message").innerText = confirmResult.error.message;
    } else {
      document.getElementById("message").innerText =
        "Abonnement r√©ussi üéâ";
    }
  });
</script>