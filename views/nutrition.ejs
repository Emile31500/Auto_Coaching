<% title = "Child Template" %>

<%- contentFor('main') %>
<h2 class="my-5">Nutrition</h2>
<div class="col">
    <h3 class="my-5"> Besoins </h3>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th scope="col"></th>
          <th scope="col">Besoin</th>
          <th scope="col">Mangé</th>
          <th scope="col">En pourcentage</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <th scope="row">Energie</th>
          <td> kcal </td>
          <td> kcal </td>
          <td> % </td>
        </tr>
        <tr>
          <th scope="row">Proteine</th>
          <td> g </td>
          <td> g </td>
          <td> % </td>
        </tr>
        <tr>
          <th scope="row">Lipide</th>
          <td> g </td>
          <td> g </td>
          <td> % </td>
        </tr>
      </tbody>
    </table>
    <div class="alert my-3 d-none" id="nutrition-alert" role="alert">
    </div>
    <h3 class="my-5 ">Aliments </h3>
    <table class="table table-striped my-3">
        <thead class="table-dark">
          <tr>
            <th scope="col">Nom </th>
            <th scope="col">Kcalorie</th>
            <th scope="col">Glucide</th>
            <th scope="col">Proteine</th>
            <th scope="col" colspan="2">Lipide</th>
          </tr>
        </thead>
        <tbody>
          <% for(var i=0; i<food.length; i++) {%>
            <tr>
              <th scope="row"><%= food[i].name %></th>
              <td> <%= ((food[i].carbohydrate + food[i].proteine) *4 + food[i].fat*9) %> kcal </td>
              <td> <%= food[i].carbohydrate %> g </td>
              <td> <%= food[i].proteine %> g </td>
              <td> <%= food[i].fat %> g </td>
              <td>
                <form action="/food/eat" class="alimentForms" method="post">
                  <div class="row"  style="max-width: 200px;">
                    <input type="number" name="foodId" hidden value=<%= food[i].id %> >
                    <div class="col">
                      <input type="number" value="5" name="weight" class="form-control" placeholder="en gramme">
                    </div>
                    <div class="col-3">
                      <input type="submit" class="btn btn-primary" value="+"/>
                    </div>
                  </div>
                </form>
              </td>
            </tr>
          <% } %>
        </tbody>
      </table>
</div>
<script>
  let alimentForms = document.querySelectorAll('.alimentForms');
  let nutrition_alert = document.querySelector('#nutrition-alert');

  alimentForms.forEach(form => {

    form.addEventListener("submit", async function(e){

      e.preventDefault();
      data = new FormData(this);

      var raw = JSON.stringify({
            "foodId": parseInt(data.get("foodId")),
            "weight": parseInt(data.get("weight"))
          })
      
      fetch('/food/eat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: raw

      }).then(response => {

        if(response.status == 201){

          nutrition_alert.innerHTML = "Votre aliment a bien été enregistré";
          nutrition_alert.classList.add('alert-success');
          nutrition_alert.classList.remove('alert-danger');
          nutrition_alert.classList.remove('d-none');

        } else {

          nutrition_alert.innerHTML = "Erreur : " // + response.message;

          nutrition_alert.classList.remove('d-none');
          nutrition_alert.classList.remove('alert-success');
          nutrition_alert.classList.add('alert-danger');

        }

        return response.json();

      }).then(data => {
        
        if(data['message'] != undefined) {

          nutrition_alert.innerHTML = '<b>Erreure :</b> <br>' + data['message']+ '';


        }

      }).catch(error => {

        nutrition_alert.innerHTML = "Erreur : " // + error.message;
        nutrition_alert.classList.remove('d-none');
        nutrition_alert.classList.remove('alert-success');
        nutrition_alert.classList.add('alert-danger');

      });
    });
  });


  function calculateEatingAliemnts(){

    
  }
</script>
