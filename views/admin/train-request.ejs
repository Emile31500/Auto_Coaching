<% title = "Child Template" %>
<%- contentFor('main') %>
<h2 class="my-5">Train request : </h2>

<table class="table my-3">
    <thead>
        <tr>
            <th scope="col"> Utilsiateur</th>
            <th scope="col"> Contact </th>
            <th scope="col"> Objectif </th>  
            <th scope="col"> Métabolisme </th>  
            <th scope="col" colspan="2"> Age </th>  
        </tr>
    </thead>
    <tbody id="bodyTrainRequestTable">
    </tbody>
</table>
<script>

    let bodyTrainRequestTable = document.querySelector('#bodyTrainRequestTable');   


    fetch('/api/admin/train/request', {

        method: 'GET',
        headers: {'Content-Type' : 'application/json'}

    }).then(response => response.json())
    .then(data => {

        if (data.code === 200) {

            data.data.forEach(trainRequest => {

                let utilisateur = getUser(trainRequest.userId);
                console.log(trainRequest.birthDay)
                let age = calculateAge(trainRequest.birthDay)

                utilisateur.then(utilisateur => { 
                
                    bodyTrainRequestTable.innerHTML +='<tr><td>' + utilisateur.name + '</td><td>'+utilisateur.email +'</td><td>'+trainRequest.objectif+'</td><td>'+trainRequest.metabolism+'</td><td>' + age + '</td><td><a href="/admin/train/request/' + trainRequest.id + '">Détail</a></td></tr>';                 
                
                });
            });

        }

    });

    async function getUser(userId) {

        const promise = await fetch('/api/user?id='+userId, {

            method: 'GET',
            headers: {'Content-Type' : 'application/json'},

        })

        let res = await promise.json();

        if (res.code === 200) {

            return res.data;

        } else {

            console.log('Error : ' +  res.code + '\n' + res.message)

        }
        
    }

   
    function calculateAge(birthDay) {

        //console.log(birthDay);
        const birthDate = new Date(birthDay);
        //console.log(birthDate);

        const currentDate = new Date();
        let age = currentDate.getFullYear() - birthDate.getFullYear();
        const hasBirthdayOccurred = (
            currentDate.getMonth() > birthDate.getMonth() ||
            (currentDate.getMonth() === birthDate.getMonth() && currentDate.getDate() >= birthDate.getDate()) ||
            (currentDate.getMonth() === birthDate.getMonth() && currentDate.getDate() === birthDate.getDate() && currentDate.getHours() >= birthDate.getHours()) ||
            (currentDate.getMonth() === birthDate.getMonth() && currentDate.getDate() === birthDate.getDate() && currentDate.getHours() === birthDate.getHours() && currentDate.getMinutes() >= birthDate.getMinutes()) ||
            (currentDate.getMonth() === birthDate.getMonth() && currentDate.getDate() === birthDate.getDate() && currentDate.getHours() === birthDate.getHours() && currentDate.getMinutes() === birthDate.getMinutes() && currentDate.getSeconds() >= birthDate.getSeconds())
        );

        if (hasBirthdayOccurred) {

            age = age - 1;
            
        }

        const intAge = age;
        return intAge;
    }
</script>
